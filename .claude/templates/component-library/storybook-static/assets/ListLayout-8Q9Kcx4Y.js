import{r as x}from"./index-GiUgBvb1.js";import{az as y,at as K,bd as S}from"./Virtualizer-43kePMo2.js";function L(a){let{initialItems:e=[],initialSelectedKeys:l,getKey:t=d=>{var h;return(h=d.id)!==null&&h!==void 0?h:d.key},filter:s,initialFilterText:i=""}=a,[r,o]=x.useState({items:e,selectedKeys:l==="all"?"all":new Set(l||[]),filterText:i}),n=x.useMemo(()=>s?r.items.filter(d=>s(d,r.filterText)):r.items,[r.items,r.filterText,s]);return{...r,items:n,...$({getKey:t},o),getItem(d){return r.items.find(h=>t(h)===d)}}}function $(a,e){let{cursor:l,getKey:t}=a;return{setSelectedKeys(s){e(i=>({...i,selectedKeys:s}))},addKeysToSelection(s){e(i=>i.selectedKeys==="all"?i:s==="all"?{...i,selectedKeys:"all"}:{...i,selectedKeys:new Set([...i.selectedKeys,...s])})},removeKeysFromSelection(s){e(i=>{if(s==="all")return{...i,selectedKeys:new Set};let r=i.selectedKeys==="all"?new Set(i.items.map(t)):new Set(i.selectedKeys);for(let o of s)r.delete(o);return{...i,selectedKeys:r}})},setFilterText(s){e(i=>({...i,filterText:s}))},insert(s,...i){e(r=>R(r,s,...i))},insertBefore(s,...i){e(r=>{let o=r.items.findIndex(n=>(t==null?void 0:t(n))===s);if(o===-1)if(r.items.length===0)o=0;else return r;return R(r,o,...i)})},insertAfter(s,...i){e(r=>{let o=r.items.findIndex(n=>(t==null?void 0:t(n))===s);if(o===-1)if(r.items.length===0)o=0;else return r;return R(r,o+1,...i)})},prepend(...s){e(i=>R(i,0,...s))},append(...s){e(i=>R(i,i.items.length,...s))},remove(...s){e(i=>{let r=new Set(s),o=i.items.filter(d=>!r.has(t(d))),n="all";if(i.selectedKeys!=="all"){n=new Set(i.selectedKeys);for(let d of s)n.delete(d)}return l==null&&o.length===0&&(n=new Set),{...i,items:o,selectedKeys:n}})},removeSelectedItems(){e(s=>{if(s.selectedKeys==="all")return{...s,items:[],selectedKeys:new Set};let i=s.selectedKeys,r=s.items.filter(o=>!i.has(t(o)));return{...s,items:r,selectedKeys:new Set}})},move(s,i){e(r=>{let o=r.items.findIndex(h=>t(h)===s);if(o===-1)return r;let n=r.items.slice(),[d]=n.splice(o,1);return n.splice(i,0,d),{...r,items:n}})},moveBefore(s,i){e(r=>{let o=r.items.findIndex(h=>t(h)===s);if(o===-1)return r;let d=(Array.isArray(i)?i:[...i]).map(h=>r.items.findIndex(u=>t(u)===h)).sort((h,u)=>h-u);return k(r,d,o)})},moveAfter(s,i){e(r=>{let o=r.items.findIndex(h=>t(h)===s);if(o===-1)return r;let d=(Array.isArray(i)?i:[...i]).map(h=>r.items.findIndex(u=>t(u)===h)).sort((h,u)=>h-u);return k(r,d,o+1)})},update(s,i){e(r=>{let o=r.items.findIndex(d=>t(d)===s);if(o===-1)return r;let n;return typeof i=="function"?n=i(r.items[o]):n=i,{...r,items:[...r.items.slice(0,o),n,...r.items.slice(o+1)]}})}}}function R(a,e,...l){return{...a,items:[...a.items.slice(0,e),...l,...a.items.slice(e)]}}function k(a,e,l){l-=e.filter(i=>i<l).length;let t=e.map(i=>({from:i,to:l++}));for(let i=0;i<t.length;i++){let r=t[i].from;for(let o=i;o<t.length;o++)t[o].from>r&&t[o].from--}for(let i=0;i<t.length;i++){let r=t[i];for(let o=t.length-1;o>i;o--){let n=t[o];n.from<r.to?r.to++:n.from++}}let s=a.items.slice();for(let i of t){let[r]=s.splice(i.from,1);s.splice(i.to,0,r)}return{...a,items:s}}function z(a,e){let l;switch(a.state){case"idle":case"error":switch(e.type){case"loading":case"loadingMore":case"sorting":case"filtering":var t,s;return{...a,filterText:(t=e.filterText)!==null&&t!==void 0?t:a.filterText,state:e.type,items:e.type==="loading"?[]:a.items,sortDescriptor:(s=e.sortDescriptor)!==null&&s!==void 0?s:a.sortDescriptor,abortController:e.abortController};case"update":var i;return{...a,...(i=e.updater)===null||i===void 0?void 0:i.call(e,a)};case"success":case"error":return a;default:throw new Error(`Invalid action "${e.type}" in state "${a.state}"`)}case"loading":case"sorting":case"filtering":switch(e.type){case"success":if(e.abortController!==a.abortController)return a;var r;l=(r=e.selectedKeys)!==null&&r!==void 0?r:a.selectedKeys;var o,n,d;return{...a,filterText:(o=e.filterText)!==null&&o!==void 0?o:a.filterText,state:"idle",items:[...(n=e.items)!==null&&n!==void 0?n:[]],selectedKeys:l==="all"?"all":new Set(l),sortDescriptor:(d=e.sortDescriptor)!==null&&d!==void 0?d:a.sortDescriptor,abortController:void 0,cursor:e.cursor};case"error":return e.abortController!==a.abortController?a:{...a,state:"error",error:e.error,abortController:void 0};case"loading":case"loadingMore":case"sorting":case"filtering":var h;(h=a.abortController)===null||h===void 0||h.abort("aborting current load and starting new one");var u;return{...a,filterText:(u=e.filterText)!==null&&u!==void 0?u:a.filterText,state:e.type,items:e.type==="loading"?[]:a.items,abortController:e.abortController};case"update":var c;return{...a,...(c=e.updater)===null||c===void 0?void 0:c.call(e,a)};default:throw new Error(`Invalid action "${e.type}" in state "${a.state}"`)}case"loadingMore":switch(e.type){case"success":var f;l=a.selectedKeys==="all"||e.selectedKeys==="all"?"all":new Set([...a.selectedKeys,...(f=e.selectedKeys)!==null&&f!==void 0?f:[]]);var g,v;return{...a,state:"idle",items:[...a.items,...(g=e.items)!==null&&g!==void 0?g:[]],selectedKeys:l,sortDescriptor:(v=e.sortDescriptor)!==null&&v!==void 0?v:a.sortDescriptor,abortController:void 0,cursor:e.cursor};case"error":return e.abortController!==a.abortController?a:{...a,state:"error",error:e.error};case"loading":case"sorting":case"filtering":var m;(m=a.abortController)===null||m===void 0||m.abort();var p;return{...a,filterText:(p=e.filterText)!==null&&p!==void 0?p:a.filterText,state:e.type,items:e.type==="loading"?[]:a.items,abortController:e.abortController};case"loadingMore":var b;return(b=e.abortController)===null||b===void 0||b.abort(),a;case"update":var I;return{...a,...(I=e.updater)===null||I===void 0?void 0:I.call(e,a)};default:throw new Error(`Invalid action "${e.type}" in state "${a.state}"`)}default:throw new Error(`Invalid state "${a.state}"`)}}function M(a){const{load:e,sort:l,initialSelectedKeys:t,initialSortDescriptor:s,getKey:i=u=>u.id||u.key,initialFilterText:r=""}=a;let[o,n]=x.useReducer(z,{state:"idle",error:void 0,items:[],selectedKeys:t==="all"?"all":new Set(t),sortDescriptor:s,filterText:r});const d=async(u,c)=>{let f=new AbortController;try{n({...u,abortController:f});var g;let p=(g=u.filterText)!==null&&g!==void 0?g:o.filterText;var v;let b=await c({items:o.items.slice(),selectedKeys:o.selectedKeys,sortDescriptor:(v=u.sortDescriptor)!==null&&v!==void 0?v:o.sortDescriptor,signal:f.signal,cursor:u.type==="loadingMore"?o.cursor:void 0,filterText:p,loadingState:o.state});var m;let I=(m=b.filterText)!==null&&m!==void 0?m:p;n({type:"success",...b,abortController:f}),I&&I!==p&&!f.signal.aborted&&d({type:"filtering",filterText:I},e)}catch(p){n({type:"error",error:p,abortController:f})}};let h=x.useRef(!1);return x.useEffect(()=>{h.current||(d({type:"loading"},e),h.current=!0)},[]),{items:o.items,selectedKeys:o.selectedKeys,sortDescriptor:o.sortDescriptor,isLoading:o.state==="loading"||o.state==="loadingMore"||o.state==="sorting"||o.state==="filtering",loadingState:o.state,error:o.error,filterText:o.filterText,getItem(u){return o.items.find(c=>i(c)===u)},reload(){d({type:"loading"},e)},loadMore(){o.state==="loading"||o.state==="loadingMore"||o.state==="filtering"||o.cursor==null||d({type:"loadingMore"},e)},sort(u){d({type:"sorting",sortDescriptor:u},l||e)},...$({...a,getKey:i,cursor:o.cursor},u=>{n({type:"update",updater:u})}),setFilterText(u){d({type:"filtering",filterText:u},e)}}}class N{shouldInvalidate(e,l){return e.width!==l.width||e.height!==l.height}shouldInvalidateLayoutOptions(e,l){return e!==l}update(e){}getItemRect(e){var l,t;return(t=(l=this.getLayoutInfo(e))===null||l===void 0?void 0:l.rect)!==null&&t!==void 0?t:null}getVisibleRect(){return this.virtualizer.visibleRect}constructor(){this.virtualizer=null}}class w{copy(){let e=new w(this.type,this.key,this.rect.copy());return e.estimatedSize=this.estimatedSize,e.opacity=this.opacity,e.transform=this.transform,e.parentKey=this.parentKey,e.content=this.content,e.isSticky=this.isSticky,e.zIndex=this.zIndex,e.allowOverflow=this.allowOverflow,e}constructor(e,l,t){this.type=e,this.key=l,this.parentKey=null,this.content=null,this.rect=t,this.estimatedSize=!1,this.isSticky=!1,this.opacity=1,this.transform=null,this.zIndex=0,this.allowOverflow=!1}}const H=48;class E extends N{get collection(){return this.virtualizer.collection}getLayoutInfo(e){var l;return this.ensureLayoutInfo(e),((l=this.layoutNodes.get(e))===null||l===void 0?void 0:l.layoutInfo)||null}getVisibleLayoutInfos(e){if(e.height>1){var l,t;let r=((t=(l=this.rowHeight)!==null&&l!==void 0?l:this.estimatedRowHeight)!==null&&t!==void 0?t:H)+this.gap;e.y=Math.floor(e.y/r)*r,e.height=Math.ceil(e.height/r)*r}this.layoutIfNeeded(e);let s=[],i=r=>{for(let o of r)this.isVisible(o,e)&&(s.push(o.layoutInfo),o.children&&i(o.children))};return i(this.rootNodes),s}layoutIfNeeded(e){if(this.lastCollection){this.requestedRect.containsRect(e)||(this.requestedRect=this.requestedRect.union(e),this.rootNodes=this.buildCollection());for(let l of this.virtualizer.persistedKeys)if(this.ensureLayoutInfo(l))return}}ensureLayoutInfo(e){return!this.layoutNodes.has(e)&&this.requestedRect.area<this.contentSize.area&&this.lastCollection?(this.requestedRect=new y(0,0,1/0,1/0),this.rootNodes=this.buildCollection(),this.requestedRect=new y(0,0,this.contentSize.width,this.contentSize.height),!0):!1}isVisible(e,l){return e.layoutInfo.rect.intersects(l)||e.layoutInfo.isSticky||e.layoutInfo.type==="header"||e.layoutInfo.type==="loader"||this.virtualizer.isPersistedKey(e.layoutInfo.key)}shouldInvalidateEverything(e){let l=e.layoutOptions;var t,s,i,r,o;return e.sizeChanged||this.rowHeight!==((t=l==null?void 0:l.rowHeight)!==null&&t!==void 0?t:this.rowHeight)||this.headingHeight!==((s=l==null?void 0:l.headingHeight)!==null&&s!==void 0?s:this.headingHeight)||this.loaderHeight!==((i=l==null?void 0:l.loaderHeight)!==null&&i!==void 0?i:this.loaderHeight)||this.gap!==((r=l==null?void 0:l.gap)!==null&&r!==void 0?r:this.gap)||this.padding!==((o=l==null?void 0:l.padding)!==null&&o!==void 0?o:this.padding)}shouldInvalidateLayoutOptions(e,l){return e.rowHeight!==l.rowHeight||e.estimatedRowHeight!==l.estimatedRowHeight||e.headingHeight!==l.headingHeight||e.estimatedHeadingHeight!==l.estimatedHeadingHeight||e.loaderHeight!==l.loaderHeight||e.dropIndicatorThickness!==l.dropIndicatorThickness||e.gap!==l.gap||e.padding!==l.padding}update(e){let l=this.virtualizer.collection;this.invalidateEverything=this.shouldInvalidateEverything(e),this.invalidateEverything&&(this.requestedRect=this.virtualizer.visibleRect.copy(),this.layoutNodes.clear());let t=e.layoutOptions;var s;this.rowHeight=(s=t==null?void 0:t.rowHeight)!==null&&s!==void 0?s:this.rowHeight;var i;this.estimatedRowHeight=(i=t==null?void 0:t.estimatedRowHeight)!==null&&i!==void 0?i:this.estimatedRowHeight;var r;this.headingHeight=(r=t==null?void 0:t.headingHeight)!==null&&r!==void 0?r:this.headingHeight;var o;this.estimatedHeadingHeight=(o=t==null?void 0:t.estimatedHeadingHeight)!==null&&o!==void 0?o:this.estimatedHeadingHeight;var n;this.loaderHeight=(n=t==null?void 0:t.loaderHeight)!==null&&n!==void 0?n:this.loaderHeight;var d;this.dropIndicatorThickness=(d=t==null?void 0:t.dropIndicatorThickness)!==null&&d!==void 0?d:this.dropIndicatorThickness;var h;this.gap=(h=t==null?void 0:t.gap)!==null&&h!==void 0?h:this.gap;var u;if(this.padding=(u=t==null?void 0:t.padding)!==null&&u!==void 0?u:this.padding,this.rootNodes=this.buildCollection(),this.lastCollection&&l!==this.lastCollection)for(let c of this.lastCollection.getKeys())l.getItem(c)||this.layoutNodes.get(c)&&this.layoutNodes.delete(c);this.lastCollection=l,this.invalidateEverything=!1,this.validRect=this.requestedRect.copy()}buildCollection(e=this.padding){let l=this.virtualizer.collection,t=[...l],s=t.filter(d=>d.type==="loader"),i=[],r=(l==null?void 0:l.size)===0;r&&(e=0);for(let d of t){var o,n;let h=((n=(o=this.rowHeight)!==null&&o!==void 0?o:this.estimatedRowHeight)!==null&&n!==void 0?n:H)+this.gap;if(d.type==="item"&&e+h<this.requestedRect.y&&!this.isValid(d,e)){e+=h;continue}let u=this.buildChild(d,this.padding,e,null);if(e=u.layoutInfo.rect.maxY+this.gap,i.push(u),d.type==="loader"){let c=s.indexOf(d);s.splice(c,1)}if((d.type==="item"||d.type==="loader")&&e>this.requestedRect.maxY){let c=t.indexOf(d);for(let f of s){let g=t.indexOf(f);e+=(g-c-1)*h;let v=this.buildChild(f,this.padding,e,null);i.push(v),e=v.layoutInfo.rect.maxY,c=g}e+=(t.length-c-1)*h;break}}return e-=this.gap,e+=r?0:this.padding,this.contentSize=new K(this.virtualizer.visibleRect.width,e),i}isValid(e,l){let t=this.layoutNodes.get(e.key);return!this.invalidateEverything&&!!t&&t.node===e&&l===t.layoutInfo.rect.y&&t.layoutInfo.rect.intersects(this.validRect)&&t.validRect.containsRect(t.layoutInfo.rect.intersection(this.requestedRect))}buildChild(e,l,t,s){if(this.isValid(e,t))return this.layoutNodes.get(e.key);let i=this.buildNode(e,l,t);return i.layoutInfo.parentKey=s??null,i.layoutInfo.allowOverflow=!0,this.layoutNodes.set(e.key,i),i}buildNode(e,l,t){switch(e.type){case"section":return this.buildSection(e,l,t);case"item":return this.buildItem(e,l,t);case"header":return this.buildSectionHeader(e,l,t);case"loader":return this.buildLoader(e,l,t);case"separator":return this.buildItem(e,l,t);default:throw new Error("Unsupported node type: "+e.type)}}buildLoader(e,l,t){let s=new y(l,t,this.padding,0),i=new w("loader",e.key,s);s.width=this.virtualizer.contentSize.width-this.padding-l;var r,o,n;return s.height=e.props.isLoading?(n=(o=(r=this.loaderHeight)!==null&&r!==void 0?r:this.rowHeight)!==null&&o!==void 0?o:this.estimatedRowHeight)!==null&&n!==void 0?n:H:0,{layoutInfo:i,validRect:s.intersection(this.requestedRect)}}buildSection(e,l,t){let s=this.virtualizer.collection,i=this.virtualizer.visibleRect.width-this.padding,r=new y(l,t,i-l,0),o=new w(e.type,e.key,r),n=t,d=0,h=[];for(let f of S(e,s)){var u,c;let g=((c=(u=this.rowHeight)!==null&&u!==void 0?u:this.estimatedRowHeight)!==null&&c!==void 0?c:H)+this.gap;if(t+g<this.requestedRect.y&&!this.isValid(e,t)){t+=g,d++;continue}let v=this.buildChild(f,l,t,o.key);if(t=v.layoutInfo.rect.maxY+this.gap,h.push(v),t>this.requestedRect.maxY){t+=([...S(e,s)].length-(h.length+d))*g;break}}return t-=this.gap,r.height=t-n,{layoutInfo:o,children:h,validRect:o.rect.intersection(this.requestedRect),node:e}}buildSectionHeader(e,l,t){let s=this.virtualizer.visibleRect.width-this.padding,i=this.headingHeight,r=!1;if(i==null){let d=this.layoutNodes.get(e.key),h=d==null?void 0:d.layoutInfo;if(h){let u=this.virtualizer.collection.getItem(e.key),c=this.lastCollection?this.lastCollection.getItem(e.key):null;i=h.rect.height,r=s!==h.rect.width||u!==c||h.estimatedSize}else i=e.rendered?this.estimatedHeadingHeight:0,r=!0}i==null&&(i=H);let o=new y(l,t,s-l,i),n=new w("header",e.key,o);return n.estimatedSize=r,{layoutInfo:n,children:[],validRect:n.rect.intersection(this.requestedRect),node:e}}buildItem(e,l,t){let s=this.virtualizer.visibleRect.width-this.padding-l,i=this.rowHeight,r=!1;if(i==null){let d=this.layoutNodes.get(e.key);d?(i=d.layoutInfo.rect.height,r=s!==d.layoutInfo.rect.width||e!==d.node||d.layoutInfo.estimatedSize):(i=this.estimatedRowHeight,r=!0)}i==null&&(i=H);let o=new y(l,t,s,i),n=new w(e.type,e.key,o);return n.estimatedSize=r,{layoutInfo:n,children:[],validRect:n.rect,node:e}}updateItemSize(e,l){let t=this.layoutNodes.get(e);if(!t)return!1;let s=this.virtualizer.collection,i=t.layoutInfo;if(i.estimatedSize=!1,i.rect.height!==l.height){let r=i.copy();r.rect.height=l.height,t.layoutInfo=r,this.validRect.height=Math.min(this.validRect.height,i.rect.y-this.validRect.y),this.requestedRect.height+=r.rect.height-i.rect.height,this.updateLayoutNode(e,i,r);let o=i.parentKey!=null?s.getItem(i.parentKey):null;for(;o;)this.updateLayoutNode(o.key,i,r),o=o.parentKey!=null?s.getItem(o.parentKey):null;return!0}return!1}updateLayoutNode(e,l,t){let s=this.layoutNodes.get(e);s&&(s.validRect=s.validRect.intersection(this.validRect),s.layoutInfo===l&&(s.layoutInfo=t))}getContentSize(){return this.contentSize}getDropTargetFromPoint(e,l,t){e+=this.virtualizer.visibleRect.x,l+=this.virtualizer.visibleRect.y;let s=new y(e,Math.max(0,l-this.gap),1,Math.max(1,this.gap*2)),i=this.getVisibleLayoutInfos(s),r=null,o=1/0;for(let u of i){if(!u.rect.intersects(s))continue;let c=Math.abs(u.rect.y-l),f=Math.abs(u.rect.maxY-l),g=Math.min(c,f);g<o&&(o=g,r=u.key)}if(r==null||this.virtualizer.collection.size===0)return{type:"root"};let n=this.getLayoutInfo(r);if(!n)return null;let d=n.rect,h={type:"item",key:n.key,dropPosition:"on"};return t(h)?l<=d.y+10&&t({...h,dropPosition:"before"})?h.dropPosition="before":l>=d.maxY-10&&t({...h,dropPosition:"after"})&&(h.dropPosition="after"):l<=d.y+d.height/2&&t({...h,dropPosition:"before"})?h.dropPosition="before":t({...h,dropPosition:"after"})&&(h.dropPosition="after"),h}getDropTargetLayoutInfo(e){let l=this.getLayoutInfo(e.key),t;if(e.dropPosition==="before")t=new y(l.rect.x,Math.max(0,l.rect.y-this.dropIndicatorThickness/2),l.rect.width,this.dropIndicatorThickness);else if(e.dropPosition==="after"){let i=this.collection.getItem(e.key);if(i){var s;let r=(s=i.level)!==null&&s!==void 0?s:0,o=this.collection.getKeyAfter(e.key);for(;o!=null;){let n=this.collection.getItem(o);if(!n||n.level<=r)break;l=this.getLayoutInfo(o)||l,o=this.collection.getKeyAfter(o)}}t=new y(l.rect.x,l.rect.maxY-this.dropIndicatorThickness/2,l.rect.width,this.dropIndicatorThickness)}else t=l.rect;return new w("dropIndicator",e.key+":"+e.dropPosition,t)}constructor(e={}){super();var l;this.rowHeight=(l=e.rowHeight)!==null&&l!==void 0?l:null;var t;this.estimatedRowHeight=(t=e.estimatedRowHeight)!==null&&t!==void 0?t:null;var s;this.headingHeight=(s=e.headingHeight)!==null&&s!==void 0?s:null;var i;this.estimatedHeadingHeight=(i=e.estimatedHeadingHeight)!==null&&i!==void 0?i:null;var r;this.loaderHeight=(r=e.loaderHeight)!==null&&r!==void 0?r:null,this.dropIndicatorThickness=e.dropIndicatorThickness||2,this.gap=e.gap||0,this.padding=e.padding||0,this.layoutNodes=new Map,this.rootNodes=[],this.lastCollection=null,this.invalidateEverything=!1,this.validRect=new y,this.requestedRect=new y,this.contentSize=new K}}export{M as $,E as a,L as b,N as c,w as d};
