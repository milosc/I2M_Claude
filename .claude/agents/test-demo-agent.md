---
name: test-demo-agent
description: Test Demo Agent - Deterministic Lifecycle Logging (v2.0)
model: sonnet
hooks:
  PostToolUse:
    - matcher: "Write|Edit"
      hooks:
        - type: command
          command: "uv run $CLAUDE_PROJECT_DIR/.claude/hooks/capture_event.py --event-type PostToolUse"
  Stop:
    - hooks:
        - type: command
          command: "uv run $CLAUDE_PROJECT_DIR/.claude/hooks/capture_event.py --event-type Stop"
---
# Test Demo Agent - Deterministic Lifecycle Logging (v2.0)

**Agent ID**: `test-demo-agent`
**Category**: Utility / Testing
**Model**: `haiku` (simple structured task)

## Purpose

This agent demonstrates the framework's agent system with **deterministic lifecycle logging** using `SubagentStop` hooks.

It is designed to be spawned via the Task tool to show how agents work within the HTEC framework.

## Lifecycle Logging Architecture (v2.0)

This agent uses **deterministic logging** with session context:

| Event | Detection Method | Name Source | Deterministic |
|-------|-----------------|-------------|---------------|
| START | Instruction-based (FIRST ACTION) | Hardcoded | Yes |
| COMPLETED | Instruction-based (before return) | Hardcoded | Yes |
| STOPPED | `SubagentStop` hook (via global settings.json) | --from-input | Yes |

**NEW in v2.0:**
- Session context from `_state/session.json` (project, stage)
- Agent name extraction via `--from-input` in global hooks
- Explicit completion logging before returning

**Logging Output**: `_state/lifecycle.json`

## Capabilities

- Generate Lorem Ipsum markdown content
- Write output to specified file path
- Log lifecycle events deterministically with session context
- Return structured JSON results

---

## Invocation Pattern

```javascript
Task({
  subagent_type: "general-purpose",
  model: "haiku",
  description: "Generate test file via agent",
  prompt: `Agent: test-demo-agent
    Read: .claude/agents/test-demo-agent.md

    TASK: Generate Lorem Ipsum test file
    OUTPUT: _state/test-demo-outputs/agent-output.md
    PARAGRAPHS: 3
    TITLE: "Agent Generated Content"

    Execute the agent logic as defined in the agent file.

    RETURN: JSON { status, output_file }`
})
```

---

## FIRST ACTION (MANDATORY)

Before doing ANYTHING else, run this exact command to log the agent start:

```bash
bash .claude/hooks/log-lifecycle.sh subagent test-demo-agent started '{"stage": "utility", "method": "instruction-based"}'
```

This is a **deterministic workaround** because there is no native `SubagentStart` event in Claude Code.

---

## Execution Steps

### Step 1: Parse Instructions

Extract parameters from the Task() prompt:

```bash
# Default values
OUTPUT="_state/test-demo-agent-output.md"
PARAGRAPHS=3
TITLE="Agent Generated Content"

echo "Test Demo Agent Executing"
echo "Output: $OUTPUT"
echo "Paragraphs: $PARAGRAPHS"
echo "Title: $TITLE"
echo ""
```

### Step 2: Generate Content

```bash
# Execute agent logic - generate Lorem Ipsum content
python3 .claude/hooks/test_demo_hook.py \
  --output "$OUTPUT" \
  --paragraphs "$PARAGRAPHS" \
  --title "$TITLE" \
  --source "test-demo-agent"
```

### Step 3: Verify Output

```bash
# Verify file was created
if [ -f "$OUTPUT" ]; then
  SIZE=$(wc -c < "$OUTPUT")
  echo "Agent execution successful"
  echo "Output file: $OUTPUT ($SIZE bytes)"
  echo ""
  echo "File preview:"
  head -20 "$OUTPUT"
  STATUS="completed"
else
  echo "Agent execution failed"
  echo "Expected output: $OUTPUT"
  STATUS="failed"
fi
```

---

## COMPLETION LOGGING (MANDATORY)

BEFORE returning your result, run this command to log completion with metadata:

```bash
bash .claude/hooks/log-lifecycle.sh subagent test-demo-agent completed '{"stage": "utility", "status": "completed", "output_file": "'$OUTPUT'"}'
```

The global SubagentStop hook is a backup only - explicit completion logging ensures accurate metadata.

---

### Step 4: Return JSON Result

```bash
echo ""
echo "Agent Execution Summary"
echo "========================"
echo "Agent: test-demo-agent"
echo "Output: $OUTPUT"
echo "Paragraphs: $PARAGRAPHS"
echo "Status: $STATUS"
echo ""
echo "Lifecycle events logged to: _state/lifecycle.json"
echo "  - subagent:test-demo-agent:started (via instruction)"
echo "  - subagent:test-demo-agent:completed (via instruction)"
echo "  - subagent:test-demo-agent:stopped (via SubagentStop hook with --from-input)"

# Return JSON for Task() tool
cat <<EOF
{
  "status": "$STATUS",
  "output_file": "$OUTPUT",
  "paragraphs": $PARAGRAPHS,
  "title": "$TITLE"
}
EOF
```

---

## Expected Output

The agent produces:

1. A markdown file at the specified output path
2. Lifecycle events in `_state/lifecycle.json`
3. JSON return status for Task() tool

### Output File Format

```markdown
# Agent Generated Content

> Generated by: `test-demo-agent`
> Timestamp: 2026-01-12T10:00:00

---

## Content

Lorem ipsum dolor sit amet...

---

## Metadata

| Property | Value |
|----------|-------|
| Source | test-demo-agent |
| Paragraphs | 3 |
| Generated | 2026-01-12T10:00:00 |
```

### Expected Lifecycle Events (v2.0)

After execution, `_state/lifecycle.json` should contain (with proper names, no "unknown"):

```json
{"component": "agent", "name": "test-demo-agent", "event": "pre_spawn", "session": "...", "project": "TestDemo", "stage": "utility"}
{"component": "subagent", "name": "test-demo-agent", "event": "started", "session": "...", "project": "TestDemo", "stage": "utility"}
{"component": "subagent", "name": "test-demo-agent", "event": "completed", "session": "...", "project": "TestDemo", "stage": "utility"}
{"component": "subagent", "name": "test-demo-agent", "event": "stopped", "session": "...", "project": "TestDemo", "stage": "utility"}
{"component": "agent", "name": "test-demo-agent", "event": "post_spawn", "session": "...", "project": "TestDemo", "stage": "utility"}
```

**Changes from v1:**
- No more `"name": "task-spawn"` - replaced with actual agent name
- No more `"name": "unknown"` - replaced with actual agent name via --from-input
- Session context (project, stage) included in all entries

---

## Integration Points

| Component | Purpose |
|-----------|---------|
| `test_demo_hook.py` | Content generation |
| `log-lifecycle.sh` | Lifecycle event logging (v2.0 with session context) |
| `session.json` | Session state (project, stage) |
| `settings.json` | Global Task/SubagentStop hooks with --from-input |
| `lifecycle.json` | Event storage |

## Key Difference: Stop vs SubagentStop

| Hook | When to Use | Fires When |
|------|-------------|------------|
| `Stop` | Commands, Skills (main agent) | Main agent finishes responding |
| `SubagentStop` | Subagents (spawned via Task) | Subagent finishes |

**CRITICAL:** Always use `SubagentStop` for agents spawned via the Task tool.

## Related

- **Hook**: `.claude/hooks/test_demo_hook.py`
- **Helper**: `.claude/hooks/log-lifecycle.sh`
- **Session hooks**: `.claude/hooks/session-init.sh`, `.claude/hooks/session-update.sh`
- **Global hooks**: `.claude/settings.json`
- **Command**: `.claude/commands/test-demo.md`
- **Skill**: `.claude/skills/test-demo-gen/SKILL.md`
- **Documentation**: `architecture/Framework_Test_Demo.md`
- **Improvement Plan**: `architecture/TelemetryImprovementPlan.md`
